pipeline {
  agent any

  stages {
    stage('Run random-csv job') {
      environment {
        JOB_NAME = 'random-csv'
        OUTPUT_FILE_NAME = 'random_numbers.csv'
      }
      steps {
        script {
          // Trigger the upstream job that generates the CSV artifact.
          def job = build job: env.JOB_NAME, wait: true

          // Pull the CSV from the specific build we just ran.
          copyArtifacts(
            projectName: env.JOB_NAME,
            selector: specific("${job.number}"),
            filter: env.OUTPUT_FILE_NAME
          )
        }
      }
    }
    stage('csv validation') {
      environment {
        EXPECTED_HEADERS = 'number'
        OUTPUT_FILE_NAME = 'random_numbers.csv'
      }
      steps {
        script {
          def status = sh(
            script: 'head -n 1 "$OUTPUT_FILE_NAME" | grep -qx "$EXPECTED_HEADERS"',
            returnStatus: true
          )
          if (status != 0) {
            error("CSV headerが不正です。期待値: ${env.EXPECTED_HEADERS}")
          }

          // Read the CSV file and extract the first number after the header.
          def csvContent = readFile('random_numbers.csv').trim().split('\n')
          if (csvContent.length < 1) {
            error "CSV file does not contain enough data."
          }
        }
      }
    }

    stage('Run multiply-param job') {
      steps {
        script {
          sh('''
            echo "Downloaded random_numbers.csv:"
            cat random_numbers.csv
          ''')

          // number列にて、行ごとにループしてmultiply-paramジョブを呼び出す
          def csvContent = readFile('random_numbers.csv').trim().split('\n')
          for (int i = 1; i < csvContent.length; i++) {
            def number = csvContent[i].trim()
            if (number) {
              echo "Triggering multiply-param job with number=${number}"
              build job: 'multiply-param', parameters: [string(name: 'number', value: number)], wait: true
            }
          }
        }
      }
    }
  }

  post {
    always {
      archiveArtifacts artifacts: 'random_numbers.csv', onlyIfSuccessful: false
    }
  }
}
